<!--
(C) Copyright 2014 Nuxeo SA (http://nuxeo.com/) and contributors.

All rights reserved. This program and the accompanying materials
are made available under the terms of the GNU Lesser General Public License
(LGPL) version 2.1 which accompanies this distribution, and is available at
http://www.gnu.org/licenses/lgpl.html

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

Contributors:
  Nelson Silva <nelson.silva@inevo.pt>
-->

<!--
@group Nuxeo Elements

The `nx-page-provider` wraps a `Document.PageProvider` operation to provide paginated results for a given `query`.

    <nx-page-provider auto
        query="select from Document"
        pageSize="5"
        sort="dc:modified"></nx-page-provider>

With `auto` set to `true`, results are fetched whenever
the `query`, `params`, `page` or `pageSize` properties are changed.

You can fetch results explicitly by calling `fetch` on the
element.

@element nx-page-provider
@homepage http://www.nuxeo.org
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="nx-operation.html">
<polymer-element name="nx-page-provider" attributes="connectionId auto provider query params pageSize page sort">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>

        <nx-operation id="operation" op="Document.PageProvider" on-response="{{onOpResponse}}"></nx-operation>

    </template>
    <script>
        Polymer('nx-page-provider', {

            /**
             * The id of a nx-connection to use.
             *
             * @attribute connectionId
             * @type string
             * @default 'nx_connection'
             */
            connectionId: 'nx_connection',

             /**
             * If true, automatically execute the operation when either `op` or `params` changes.
             *
             * @attribute auto
             * @type boolean
             * @default false
             */
            auto: false,

            /**
             * The id of a page provider.
             *
             * @attribute provider
             * @type string
             * @default ''
             */
            provider: '',

            /**
             * The query.
             *
             * @attribute query
             * @type string
             * @default null
             */
            query: null,

            /**
             * The query parameters.
             *
             * @attribute params
             * @type string
             * @default null
             */
            params: null,

            /**
             * The number of results per page.
             *
             * @attribute pageSize
             * @type number
             * @default 5
             */
            pageSize: 5,

            /**
             * The current page.
             *
             * @attribute page
             * @type number
             * @default 1
             */
            page: 1,

            observe: {
                'query pageSize page': 'autoFetch'
            },
            ready: function() {
                this.connection = document.querySelector('#' + this.connectionId);
            },

            /**
            * Executes the operation to fetch the results.
            *
            * @method fetch
            */
            fetch: function() {
                this.$.operation.params = {
                    page: this.page - 1,
                    pageSize: this.pageSize,
                    providerName: this.provider,
                    query: this.query,
                    queryParams: this.params,
                    sortInfo: this.sort
                };
                this.results = [];
                this.$.operation.execute();
            },
            autoFetch: function() {
                // Reset the page if the query changes
                if (this.$.operation.params && (this.query !== this.$.operation.params.query)) {
                    this.page = 1;
                }
                if (this.auto) {
                    this.fetch();
                }
            },
            onOpResponse: function() {
                var response = this.$.operation.response;
                this.results = response.entries.slice(0);
                this.numberOfPages = response.numberOfPages;
            }

        });
    </script>

</polymer-element>
