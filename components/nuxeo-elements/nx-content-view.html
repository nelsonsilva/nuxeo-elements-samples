<!--
(C) Copyright 2014 Nuxeo SA (http://nuxeo.com/) and contributors.

All rights reserved. This program and the accompanying materials
are made available under the terms of the GNU Lesser General Public License
(LGPL) version 2.1 which accompanies this distribution, and is available at
http://www.gnu.org/licenses/lgpl.html

This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
Lesser General Public License for more details.

Contributors:
  Nelson Silva <nelson.silva@inevo.pt>
-->

<!--
@group Nuxeo Elements

The `nx-content-view` provides a listing supported by a `nx-page-provider`.

    <nx-content-view>
        <nx-page-provider auto pageSize="5"
            query="select * from Document"></nx-page-provider>
        <template>
            {{item.title}}
        </template>
    </nx-content-view>

The `<template>` content will be used for rendering each item.
Data is bound to `item`.

@element nx-content-view
@homepage http://www.nuxeo.org
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../core-selection/core-selection.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="nx-layout.html">
<polymer-element name="nx-content-view" on-tap="{{tapHandler}}" attributes="multi resultTemplates">
    <template>
        <style>
            .pagination span {
                color: #777;
                vertical-align: middle;
                font-weight: bold;
                margin: 0 .5em;
                font-size: .9em;
            }

            .pagination input {
                vertical-align: middle;
            }

            .pagination input[disabled] {
                opacity: .4;
                cursor: default;
            }
        </style>



        <core-selection id="selection" multi="{{multiSelect}}" on-core-select="{{selectedHandler}}"></core-selection>

        <div layout vertical center>
            <div class="upperActions" layout horizontal>
                <!-- content_view_page_size_selector.xhtml -->
                <div layout horizontal>
                  Items/page
                  <select value="{{provider.pageSize}}">
                    <option>5</option>
                    <option>10</option>
                    <option>20</option>
                    <option>30</option>
                    <option>40</option>
                    <option>50</option>
                  </select>
                </div>
                <!-- content_view_result_layout_actions.xhtml -->
                <template if="{{resultLayouts.length > 1}}">
                    <template repeat="{{layout in resultLayouts}}">
                        <button on-click="{{setCurrentResultLayout}}" data-layout="{{layout}}" title="{{layout}}">
                        {{layout}}
                        </button>
                    </template>
                </template -->

                <!-- content_view_export_actions.xhtml -->
            </div>

            <!-- Entries -->
            <div id="results" layout vertical on-tap="{{tapHandler}}">
              <template repeat="{{doc in provider.results}}">
                <template ref="{{currentResultLayout}}" bind="{{doc}}"></template>
              </template>
            </div>

             <!-- Pagination -->
            <template if="{{provider.numberOfPages > 1}}">
              <div class="pagination">
                  <input disabled?="{{provider.page == 1}}" type="image" on-click="{{setPage}}" data-item="1" src="icons/navigation_first.png">
                  <input disabled?="{{provider.page == 1}}" type="image" on-click="{{setPage}}" data-item="{{provider.page - 1}}" src="icons/navigation_previous.png">
                  <span>{{provider.page}} / {{provider.numberOfPages}}</span>
                  <input disabled?="{{provider.page == provider.numberOfPages}}" type="image" on-click="{{setPage}}" data-item="{{provider.page + 1}}" src="icons/navigation_next.png">
                  <input disabled?="{{provider.page == provider.numberOfPages}}" type="image" on-click="{{setPage}}" data-item="{{provider.numberOfPages}}" src="icons/navigation_last.png">
              </div>
            </template>
        </div>

    </template>
    <script>
        Polymer('nx-content-view', {
            provider: null,

            /**
            *
            * Set to true to support multiple selection.
            *
            * @attribute multiSelect
            * @type boolean
            * @default false
            */
            multiSelect: false,

            observe: {
                'template provider.results': 'updateData'
            },

            attached: function() {
                // Get the page provider
                this.provider = this.querySelector('nx-page-provider');
            },

            resultTemplatesChanged: function() {
              this.resultLayouts = (typeof this.resultTemplates === 'string') ?
                this.resultTemplates.split(',') : this.resultTemplates;

              this.resultLayouts.forEach(function(templateId) {
                /* copy template from content into shadow dom */
                if(!this.shadowRoot.getElementById(templateId)){
                  var t = this.querySelector('#'+templateId);
                  // This template is not in the content
                  // Assume it's an existing nuxeo layout
                  if (!t) {
                    // Create <nx-layout ref='templateId' value='{{doc}}'>
                    var l = document.createElement('nx-layout');
                    l.ref = templateId;
                    // create <template>
                    t = document.createElement('template');
                    t.id = templateId;
                    // bind the nx-layout value to the template model
                    l.bind('value', new PathObserver(t, 'model'));
                  }
                  this.shadowRoot.appendChild(t);
                }
              },this);
              this.currentResultLayout = this.resultLayouts[0];
            },

            setCurrentResultLayout: function(e,d,t) {
              this.currentResultLayout = t.dataset.layout;
            },

            setPage: function(e,d,t) {
                this.provider.page = parseInt( t.dataset.item, 10 );
            },
            // list selection
            tapHandler: function(e) {
              if (e.target === this) {
                return;
              }
              var doc = e.target.templateInstance.model;
              this.$.selection.select(doc);
              this.asyncFire('document-selected', {doc: doc, item: e.target});
            },

            selectedHandler: function(e, detail) {
              // detail.item.classList.toggle('selected', detail.isSelected);
            }
        });
    </script>

</polymer-element>
